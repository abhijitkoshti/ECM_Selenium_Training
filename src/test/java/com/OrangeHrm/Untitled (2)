package com.sn.listeners;

import java.io.File;
import java.io.IOException;

import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;
import org.testng.ITestContext;
import org.testng.ITestListener;
import org.testng.ITestResult;

import com.aventstack.extentreports.MediaEntityBuilder;
import com.aventstack.extentreports.Status;
import com.sn.apt.util.AutoPilotUtil;
import com.sn.config.BaseConfig;
import com.sn.pageobjects.CommanActionsPage;

/**
 * @author Pankaj Tarar
 */
public class TestListener extends BaseConfig implements ITestListener {

    private static final Logger LOGGER = LogManager.getLogger(TestListener.class);

    /**
     * @param context ITestContext
     */
    public void onStart(final ITestContext context) {
        LOGGER.info("*** Test Suite " + context.getName() + " started ***");

        ExtentTestManager.getTest();
    }

    /**
     * @param context ITestContext
     */
    public void onFinish(final ITestContext context) {
        LOGGER.info(("*** Test Suite " + context.getName() + " ending ***"));
        ExtentTestManager.endTest();
        ExtentManager.getInstance().flush();
    }

    /**
     * @param result ITestResult
     */
    public void onTestStart(final ITestResult result) {
        LOGGER.info(("*** Running test method " + result.getMethod().getMethodName() + "..."));

        final String name =
            result.getInstanceName().substring(18) + " :: " + result.getMethod().getMethodName();
        ExtentTestManager.startTest(name);

    }

    /**
     * @param result ITestResult
     */
    public void onTestSuccess(final ITestResult result) {
        LOGGER.info("*** Executed " + result.getMethod().getMethodName() + " test successfully...");
        ExtentTestManager.getTest().log(Status.PASS, "Test Completed");
    }

    /**
     * @param result ITestResult
     */
    public void onTestFailure(final ITestResult result) {
        LOGGER.info("*** Test execution " + result.getMethod().getMethodName() + " failed...");
        try {
            ExtentTestManager.getTest().log(Status.FAIL, "Failed Case is: " + result.getName());
            final String cDate = AutoPilotUtil.currentDate("yyyyMMddHHmm");
            AutoPilotUtil.getScreenshot(
                getBaseDriver(),
                result.getMethod().getMethodName(),
                CommanActionsPage.getScreenShotPath());
            final String path =
                CommanActionsPage.getScreenShotPath() + result.getMethod().getMethodName() + "_"
                    + cDate + ".png";
            ExtentTestManager.getTest().log(Status.INFO, "Path: " + path);
            ExtentTestManager.getTest().log(
                Status.INFO,
                "Filepath " + CommanActionsPage.getScreenShotPath());
            ExtentTestManager.getTest().fail(
                "Test Step failed. Screenshot is attached :: ",
                MediaEntityBuilder
                    .createScreenCaptureFromPath(
                        ".\\Screenshots" + File.separator + result.getMethod().getMethodName() + "_"
                            + cDate + ".png")
                    .build());
            ExtentTestManager.getTest().log(
                Status.FAIL,
                "Exception :: " + result.getName() + " FAIL with error " + result.getThrowable());
        } catch (final IOException e) {
            LOGGER.error(" Unable to perform operations on test failure in listeners. " + e);
            ExtentTestManager.getTest().log(
                Status.FAIL,
                " Unable to perform operations on test failure in listeners. " + e.getMessage());

        }
        ExtentTestManager.getTest().log(Status.FAIL, "Test Failed");
    }

    /**
     * @param result ITestResult
     */
    public void onTestSkipped(final ITestResult result) {
        LOGGER.info("*** Test " + result.getMethod().getMethodName() + " skipped...");
        ExtentTestManager.getTest().log(Status.SKIP, "Test Skipped");
    }

    /**
     * @param result ITestResult
     */
    public void onTestFailedButWithinSuccessPercentage(final ITestResult result) {
        LOGGER.info(
            "*** Test failed but within percentage % " + result.getMethod().getMethodName());
    }

}
